name: Build and Release

on:
  push:
    branches:
      - fix-ci
      - dev
      - master
    paths:
      - '**.py'
      - '**.yml'
      - '**.yaml'
      - 'pyproject.toml'
      - 'pdm.lock'

permissions:
  contents: write  # 用于上传 Release 资源
  actions: write   # 用于创建 Release

jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [macos-latest, windows-latest]  # 只针对 macOS 和 Windows 构建
        python-version: [3.11]
        include:
          - os: macos-latest
            spec: GameYamlSpider.spec
          - os: windows-latest
            spec: GameYamlSpider.spec

    steps:
      - uses: actions/checkout@v4

      - name: Get Version from pyproject.toml
        id: get_version
        run: |
          version=$(grep -Po '(?<=version = ")[^"]+' pyproject.toml)
          echo "version=$version" >> $GITHUB_ENV

      - name: Get Last Commit Version
        id: last_commit_version
        run: |
          commit_version=$(git log -1 --pretty=%B | grep -oP 'v?\d+\.\d+\.\d+' || echo "none")
          echo "last_commit_version=$commit_version" >> $GITHUB_ENV

      - name: Check if Versions Match
        id: check_versions
        run: |
          if [[ "${{ env.version }}" == "${{ env.last_commit_version }}" ]]; then
            echo "Versions match, skipping build."
            echo "skip_build=true" >> $GITHUB_ENV
          else
            echo "Versions do not match, proceeding with build."
            echo "skip_build=false" >> $GITHUB_ENV

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}
        if: env.skip_build != 'true'

      - name: Cache pip dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ matrix.python-version }}-${{ hashFiles('pdm.lock') }}
        if: env.skip_build != 'true'

      - name: Install PDM
        run: pip install pdm
        if: env.skip_build != 'true'

      - name: Install Dependencies
        run: |
          pdm install
          pdm run pip install pyinstaller
        if: env.skip_build != 'true'

      - name: Build Binary with PyInstaller
        run: |
          pdm run pyinstaller GameYamlSpider.spec
        env:
          PATH: ${{ github.workspace }}/.pdm/bin:${{ env.PATH }}
        if: env.skip_build != 'true'

      - name: Package with Zipfile
        run: |
          python -m zipfile -c dist/GameYamlSpider.zip dist/GameYamlSpider
        if: env.skip_build != 'true'

  release:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - uses: actions/checkout@v4

      - name: Check Previous Release
        id: release-check
        uses: actions/github-script@v9
        with:
          script: |
            const releases = await github.repos.listReleases({
              owner: context.repo.owner,
              repo: context.repo.repo
            });
            const exists = releases.data.some(r => r.tag_name === `v${process.env.version}`);
            core.setOutput('exists', exists);

      - name: Create Release
        if: steps.release-check.outputs.exists != 'true'
        uses: actions/create-release@v1
        with:
          tag_name: v${{ env.version }}
          release_name: Release v${{ env.version }}
          draft: false
          prerelease: ${{ env.prerelease }}

      - name: Upload Release Assets
        uses: actions/upload-release-asset@v3
        with:
          repo: ${{ github.repository }}
          release_id: ${{ steps.create-release.outputs.id }}
          asset_path: dist/GameYamlSpider.zip
          asset_name: ${{ matrix.os }}-binary-${{ env.version }}.zip
          asset_content_type: application/zip
